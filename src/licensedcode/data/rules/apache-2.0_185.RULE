Based on code from Snap.svg (Apache 2 license)