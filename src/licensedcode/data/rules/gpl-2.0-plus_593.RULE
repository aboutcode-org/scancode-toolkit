Adapted from OProfile GPLv2 support
