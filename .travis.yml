
################################################################################
# We use Travis to run minimal smoke tests suites on Pythons 3.6
# on macOS and Linux
# We also run the documentation build and the ABOUT file checks
################################################################################

matrix:
  include:
    # Run minimal test suite
    - os: osx
      osx_image: xcode10
      language: generic
      env: 
        - PYTHON=36
        - TEST_SUITE="bin/py.test -vvs --reruns 3 tests/scancode"

    - os: linux
      sudo: required
      env: TEST_SUITE="bin/py.test -vvs --reruns 3 tests/scancode"
      language: python
      python: "3.6"
      dist: xenial

    - os: linux
      sudo: required
      env: TEST_SUITE="bin/py.test -vvs --reruns 3 tests/scancode"
      language: python
      python: "3.6"
      dist: bionic

    # Check and lint the documentation files
    - os: linux
      sudo: required
      script: 
        - source bin/activate
        - cd docs
        - pip install -r requirements-doc.txt
        # Check that the Sphinx Documentation build minimally
        - sphinx-build -E source build
        # Check for documentation style errors
        - ./scripts/doc8_style_check.sh
      language: python
      python: "3.6"
      dist: bionic

    # Check and lint .ABOUT files
    - os: linux
      sudo: required
      script: 
        - source bin/activate
        - ./bin/about check src/
        - ./bin/about check etc/
        - ./bin/about check scancode-toolkit.ABOUT
      language: python
      python: "3.6"
      dist: bionic

addons:
  homebrew:
    packages:
        - openssl
        - readline
        - sqlite3
        - xz
        - zlib
        - pyenv
    update: false

before_install:
  - chmod +x ./docs/scripts/sphinx_build_link_check.sh
  - chmod +x ./docs/scripts/doc8_style_check.sh

  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
    curl -LO https://raw.githubusercontent.com/GiovanniBussi/macports-ci/master/macports-ci;
    source ./macports-ci install;
    fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
    yes | sudo port install python$PYTHON;
    yes | sudo port install py$PYTHON-pip;
    sudo port select --set python3 python$PYTHON;
    sudo port select --set pip pip$PYTHON;
    export PATH=$PATH:/Users/travis/Library/Python/$PYTHON/bin;
    fi

install:
  - PYTHON_EXE=python3 ./configure

script:
  # If debugging, use a subset of tests to wait less:
  # - ./bin/py.test -n 2 -vvs tests/scancode
  # - echo $TEST_SUITE
  - $TEST_SUITE

notifications:
  irc:
    channels:
      - "chat.freenode.net#aboutcode"
  on_success: change
  on_failure: always
  use_notice: true
  skip_join: true
  template:
    - "%{repository_slug}#%{build_number} (%{branch}-%{commit}:%{author})-%{message}- %{build_url}"
